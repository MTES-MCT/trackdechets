FROM node:24-alpine

WORKDIR /app

# This assumes you run the build command BEFORE docker build
# Copy the UI server build output (apps/ui/dist) to /app
# This puts main.js at /app/main.js
COPY apps/ui/dist .

# Copy the frontend static files (front/dist) that the server needs to serve
# The server code expects these files at /app/front/dist
COPY front/dist ./front/dist

# Note: package.json is already included in apps/ui/dist from the nx build
# (generated by generatePackageJson: true in project.json)

RUN npm install --omit=dev

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 trackdechets
USER trackdechets

CMD ["node", "main.js"]