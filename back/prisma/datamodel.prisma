type User {
  id: ID! @id
  isActive: Boolean @default(value: false)
  email: String! @unique
  password: String!
  name: String
  phone: String

  companyAssociations: [CompanyAssociation]

  createdAt: DateTime! @createdAt
  updatedAt: DateTime! @updatedAt
}

type CompanyAssociation {
  id: ID! @id

  user: User!
  company: Company! @relation(link: INLINE)
  role: UserRole!
}

enum UserRole {
  MEMBER
  ADMIN
}

type UserActivationHash {
  id: ID! @id
  user: User! @relation(link: TABLE)
  hash: String! @unique

  createdAt: DateTime! @createdAt
  updatedAt: DateTime! @updatedAt
}

type UserAccountHash {
  id: ID! @id
  email: String!
  companySiret: ID!
  role: UserRole!
  hash: String! @unique

  createdAt: DateTime! @createdAt
  updatedAt: DateTime! @updatedAt
}

enum CompanyType {
  PRODUCER
  COLLECTOR
  WASTEPROCESSOR
  TRANSPORTER
  WASTE_VEHICLES
  WASTE_CENTER
  TRADER
}

type Company {
  id: ID! @id
  siret: String! @unique
  companyTypes: [CompanyType!]! @scalarList(strategy: RELATION)

  name: String
  gerepId: String
  codeNaf: String

  createdAt: DateTime! @createdAt
  updatedAt: DateTime! @updatedAt

  securityCode: Int!

  # Given name used in company selector
  givenName: String

  # Contact information for the "Fiche entreprise"
  contactEmail: String
  contactPhone: String
  website: String

  documentKeys: [String!] @scalarList(strategy: RELATION)
}

"""
enum Seveso
NS = Non Seveso
NB = Seveso Seuil Bas
SH = Seveso Seuil Haut
"""
enum Seveso {
  NS
  SB
  SH
}

"""
Installation classées pour la protection de l'environnement (ICPE)
"""
type Installation {
  id: ID! @id
  codeS3ic: String
  nomEts: String
  regime: String
  libRegime: String
  seveso: Seveso
  libSeveso: String
  familleIc: String
  urlFiche: String
  s3icNumeroSiret: String
  irepNumeroSiret: String
  gerepNumeroSiret: String
  sireneNumeroSiret: String
}

enum WasteType {
  INERTE
  NOT_DANGEROUS
  DANGEROUS
}

"""
Nomenclature ICPE
A Rubrique is an authorization for a specific waste operation
on a specific waste category and for a specific volume
"""
type Rubrique {
  id: ID! @id
  codeS3ic: String
  rubrique: String
  alinea: String
  dateAutorisation: String
  etatActivite: String
  regimeAutorise: String
  activite: String
  volume: String
  unite: String
  category: String
  wasteType: WasteType
}

enum GerepType {
  Producteur
  Traiteur
}

"""
GEREP (Déclaration annuelle des émissions et des transferts
de polluants)
"""
type Declaration {
  id: ID! @id
  codeS3ic: String
  nomEts: String
  annee: String
  codeDechet: String
  libDechet: String
  gerepType: GerepType
}

enum WasteAcceptationStatus {
  ACCEPTED
  REFUSED
  PARTIALLY_REFUSED
}

type Form {
  id: ID! @id
  readableId: String @unique
  customId: String
  isDeleted: Boolean @default(value: false)

  owner: User! @relation(link: TABLE)
  createdAt: DateTime! @createdAt
  updatedAt: DateTime! @updatedAt

  # Workflow fields
  signedByTransporter: Boolean

  status: String @default(value: "DRAFT")
  sentAt: DateTime
  sentBy: String

  isAccepted: Boolean
  wasteAcceptationStatus: WasteAcceptationStatus
  wasteRefusalReason: String
  receivedBy: String
  receivedAt: DateTime
  quantityReceived: Float

  processedBy: String
  processedAt: String
  processingOperationDone: String
  processingOperationDescription: String
  noTraceability: Boolean

  # Next destination fields (frame 12)
  nextDestinationProcessingOperation: String
  nextDestinationCompanyName: String
  nextDestinationCompanySiret: String
  nextDestinationCompanyAddress: String
  nextDestinationCompanyContact: String
  nextDestinationCompanyPhone: String
  nextDestinationCompanyMail: String

  # Emitter fields
  emitterType: EmitterType
  emitterPickupSite: String

  emitterCompanyName: String
  emitterCompanySiret: String
  emitterCompanyAddress: String
  emitterCompanyContact: String
  emitterCompanyPhone: String
  emitterCompanyMail: String

  # Recipient fields
  recipientCap: String
  recipientProcessingOperation: String

  recipientCompanyName: String
  recipientCompanySiret: String
  recipientCompanyAddress: String
  recipientCompanyContact: String
  recipientCompanyPhone: String
  recipientCompanyMail: String

  # Transporter fields
  transporterCompanyName: String
  transporterCompanySiret: String

  transporterCompanyAddress: String
  transporterCompanyContact: String
  transporterCompanyPhone: String
  transporterCompanyMail: String
  transporterIsExemptedOfReceipt: Boolean
  transporterReceipt: String
  transporterDepartment: String
  transporterValidityLimit: DateTime
  transporterNumberPlate: String

  # Waste details fields
  wasteDetailsCode: String
  wasteDetailsName: String
  wasteDetailsOnuCode: String
  wasteDetailsPackagings: Json
  wasteDetailsOtherPackaging: String
  wasteDetailsNumberOfPackages: Int
  wasteDetailsQuantity: Float
  wasteDetailsQuantityType: QuantityType
  wasteDetailsConsistence: Consistence

  # Trader fields
  traderCompanyName: String
  traderCompanySiret: String

  traderCompanyAddress: String
  traderCompanyContact: String
  traderCompanyPhone: String
  traderCompanyMail: String
  traderReceipt: String
  traderDepartment: String
  traderValidityLimit: DateTime

  appendix2Forms: [Form]
}

enum EmitterType {
  PRODUCER
  OTHER
  APPENDIX1
  APPENDIX2
}

enum QuantityType {
  REAL
  ESTIMATED
}

enum Consistence {
  SOLID
  LIQUID
  GASEOUS
}

enum Status {
  DRAFT
  SEALED
  SENT
  RECEIVED
  PROCESSED
  AWAITING_GROUP
  GROUPED
  NO_TRACEABILITY
  REFUSED
}

type StatusLog {
  id: ID! @id
  user: User!
  form: Form!
  status: Status!
  loggedAt: DateTime
  updatedFields: Json
}


"""
OAuth2 - Access token to a user resource
https://tools.ietf.org/html/rfc6749#section-5
"""
type AccessToken {
  id: ID! @id
  createdAt: DateTime! @createdAt
  updatedAt: DateTime! @updatedAt
  user: User!
  application: Application
  token: String! @unique
  isRevoked: Boolean! @default(value: false)
  lastUsed: DateTime
}


"""
OAuth2 - Application (Client on the Authorization server)
"""
type Application {
  # id used as clientId
  id: ID! @id
  createdAt: DateTime! @createdAt
  updatedAt: DateTime! @updatedAt
  # Confidential secret issued to the client
  clientSecret: String!
  # Friendly name for the application
  name: String!
  admins: [User!]!
  # The list of allowed redirect uris
  redirectUris: [String!]! @scalarList(strategy: RELATION)
  logoUrl: String
}

"""
OAuth2 - Grant represents a token with a short lifetime
that can be swapped for an access token
https://tools.ietf.org/html/rfc6749#section-4.1.2
"""
type Grant {
  id: ID! @id
  createdAt: DateTime! @createdAt
  updatedAt: DateTime! @updatedAt
  # The user who requested the grant
  user: User!
  # The authorization code generated by the autorization server
  code: String! @unique
  # Application instance this grant was asked for
  application: Application!
  # Expires time in seconds
  expires: Int!
  redirectUri: String!
}

