# CloudNativePG Cluster
# Requires CloudNativePG operator to be installed
# kubectl apply -f https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.22/releases/cnpg-1.22.0.yaml
---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres
  namespace: trackdechets
spec:
  instances: 3
  imageName: ghcr.io/cloudnative-pg/postgresql:16.8

  postgresql:
    parameters:
      max_connections: "200"
      shared_buffers: "256MB"
      effective_cache_size: "1GB"
      maintenance_work_mem: "64MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "2621kB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"
      max_worker_processes: "4"
      max_parallel_workers_per_gather: "2"
      max_parallel_workers: "4"
      max_parallel_maintenance_workers: "2"

  bootstrap:
    initdb:
      database: trackdechets
      owner: trackdechets
      secret:
        name: postgres-credentials

  storage:
    size: 50Gi
    storageClass: standard

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "2000m"

  # Connection pooling via PgBouncer
  pooler:
    enabled: true
    type: rw
    instances: 3
    pgbouncer:
      poolMode: transaction
      parameters:
        max_client_conn: "1000"
        default_pool_size: "25"
        max_db_connections: "100"

  # Monitoring
  monitoring:
    enabled: true
    podMonitorEnabled: true

  # Backup configuration (configure for external S3)
  backup:
    barmanObjectStore:
      destinationPath: s3://trackdechets-postgres-backups/
      endpointURL: https://s3.fr-par.scw.cloud
      s3Credentials:
        accessKeyId:
          name: postgres-backup-credentials
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: postgres-backup-credentials
          key: SECRET_ACCESS_KEY
      wal:
        compression: gzip
        maxParallel: 2
      data:
        compression: gzip
        immediateCheckpoint: true
    retentionPolicy: "30d"

  # High availability
  primaryUpdateStrategy: unsupervised

  # Affinity rules to spread instances
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: cnpg.io/cluster
                  operator: In
                  values:
                    - postgres
            topologyKey: kubernetes.io/hostname

---
# Secret for PostgreSQL user credentials
apiVersion: v1
kind: Secret
metadata:
  name: postgres-credentials
  namespace: trackdechets
type: kubernetes.io/basic-auth
stringData:
  username: trackdechets
  password: changeme-generate-strong-password

---
# Secret for backup S3 credentials
apiVersion: v1
kind: Secret
metadata:
  name: postgres-backup-credentials
  namespace: trackdechets
type: Opaque
stringData:
  ACCESS_KEY_ID: changeme
  SECRET_ACCESS_KEY: changeme

---
# Scheduled backup
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: postgres-backup-schedule
  namespace: trackdechets
spec:
  schedule: "0 2 * * *" # Daily at 2 AM
  backupOwnerReference: self
  cluster:
    name: postgres
