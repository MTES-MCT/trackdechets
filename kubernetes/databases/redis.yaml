# Redis Cluster using Bitnami Redis Chart
# Install with Helm:
# helm repo add bitnami https://charts.bitnami.com/bitnami
# helm install redis bitnami/redis -n trackdechets -f kubernetes/databases/redis-values.yaml
#
# Or use Redis Operator for GitOps:
# kubectl apply -f https://raw.githubusercontent.com/spotahome/redis-operator/master/manifests/databases.spotahome.com_redisfailovers.yaml
# kubectl apply -f https://raw.githubusercontent.com/spotahome/redis-operator/master/example/operator.yaml

---
apiVersion: databases.spotahome.com/v1
kind: RedisFailover
metadata:
  name: redis
  namespace: trackdechets-backend
spec:
  sentinel:
    replicas: 3
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 400m
        memory: 512Mi
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: redis-sentinel
              topologyKey: kubernetes.io/hostname

  redis:
    replicas: 3
    image: redis:5.0-alpine
    customConfig:
      - "maxmemory 2gb"
      - "maxmemory-policy allkeys-lru"
      - "save 900 1"
      - "save 300 10"
      - "save 60 10000"
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi
    storage:
      persistentVolumeClaim:
        metadata:
          name: redis-data
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi
          storageClassName: standard
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: redis
              topologyKey: kubernetes.io/hostname
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9121"

---
# Alternative: Helm values file for Bitnami Redis
# Save this as redis-values.yaml and use with Helm
# ---
# architecture: replication
# auth:
#   enabled: false
# master:
#   count: 1
#   persistence:
#     enabled: true
#     size: 10Gi
#   resources:
#     requests:
#       cpu: 200m
#       memory: 512Mi
#     limits:
#       cpu: 1000m
#       memory: 2Gi
#   podAntiAffinityPreset: soft
# replica:
#   replicaCount: 2
#   persistence:
#     enabled: true
#     size: 10Gi
#   resources:
#     requests:
#       cpu: 200m
#       memory: 512Mi
#     limits:
#       cpu: 1000m
#       memory: 2Gi
#   podAntiAffinityPreset: soft
# sentinel:
#   enabled: true
#   quorum: 2
# metrics:
#   enabled: true
#   serviceMonitor:
#     enabled: true
