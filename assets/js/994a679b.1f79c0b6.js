(self.webpackChunktd_doc=self.webpackChunktd_doc||[]).push([[323],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=l(n),m=r,h=c["".concat(p,".").concat(m)]||c[m]||d[m]||i;return n?a.createElement(h,o(o({ref:t},u),{},{components:n})):a.createElement(h,o({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=c;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<i;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},60490:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},metadata:function(){return p},toc:function(){return l},default:function(){return d}});var a=n(22122),r=n(19756),i=(n(67294),n(3905)),o=["components"],s={title:"Faire des appels \xe0 l'API GraphQL"},p={unversionedId:"guides/graphql",id:"guides/graphql",isDocsHomePage:!1,title:"Faire des appels \xe0 l'API GraphQL",description:"Point de terminaison GraphQL",source:"@site/docs/guides/graphql.md",sourceDirName:"guides",slug:"/guides/graphql",permalink:"/guides/graphql",editUrl:"https://github.com/MTES-MCT/trackdechets/doc/docs/guides/graphql.md",version:"current",frontMatter:{title:"Faire des appels \xe0 l'API GraphQL"},sidebar:"docs",previous:{title:"Introduction",permalink:"/"},next:{title:"OAuth2",permalink:"/guides/oauth2"}},l=[{value:"Point de terminaison GraphQL",id:"point-de-terminaison-graphql",children:[]},{value:"Authentification",id:"authentification",children:[]},{value:"Communiquer avec l&#39;API GraphQL",id:"communiquer-avec-lapi-graphql",children:[]},{value:"\xc0 propos des op\xe9rations de type <code>query</code> et <code>mutation</code>",id:"\xe0-propos-des-op\xe9rations-de-type-query-et-mutation",children:[{value:"Queries",id:"queries",children:[]},{value:"Mutations",id:"mutations",children:[]}]}],u={toc:l};function d(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"point-de-terminaison-graphql"},"Point de terminaison GraphQL"),(0,i.kt)("p",null,"L'API GraphQL Trackd\xe9chets expose un point de terminaison unique"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("a",{parentName:"p",href:"https://api.trackdechets.beta.gouv.fr"},"https://api.trackdechets.beta.gouv.fr"))),(0,i.kt)("p",null,"Nous avons \xe9galement mis en place des ",(0,i.kt)("a",{parentName:"p",href:"/guides/environments"},"environnements de test")," avec des points de terminaison distincts."),(0,i.kt)("h2",{id:"authentification"},"Authentification"),(0,i.kt)("p",null,"L'authentifcation \xe0 l'API se fait \xe0 l'aide d'un token (ou jeton d'acc\xe8s) de type \"Bearer\". Suivez les instructions dans ",(0,i.kt)("a",{parentName:"p",href:"/guides/access-token"},"Obtenir un jeton d'acc\xe8s personnel")," pour en obtenir un."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Si vous d\xe9veloppez un logiciel SaaS d\xe9sirant obtenir un token pour faire des appels \xe0 l'API pour le compte d'utilisateurs tiers, nous recommandons d'impl\xe9menter le ",(0,i.kt)("a",{parentName:"p",href:"/guides/oauth2"},"protocole OAuth2")))),(0,i.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"La mutation ",(0,i.kt)("inlineCode",{parentName:"p"},"login(email, password)")," qui permet d'obtenir un token via l'API GraphQL \xe0 partir de l'email et mot de passe est d\xe9sormais d\xe9pr\xe9ci\xe9e."))),(0,i.kt)("p",null," Un token est li\xe9 \xe0 un utilisateur. Les droits d'acc\xe8s du token d\xe9coule donc directement des droits de l'utilisateur qui a g\xe9n\xe9r\xe9 le token. Le token doit \xeatre ajout\xe9 \xe0 l'en-t\xeate ",(0,i.kt)("inlineCode",{parentName:"p"},"Authorization")," de chaque requ\xeate faite \xe0 l'API Trackd\xe9chets."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Les tokens personnels g\xe9n\xe9r\xe9s depuis votre compte Trackd\xe9chets ont une dur\xe9e de validit\xe9 infinie. Il sera bient\xf4t possible de les r\xe9voquer depuis le m\xeame espace"))),(0,i.kt)("h2",{id:"communiquer-avec-lapi-graphql"},"Communiquer avec l'API GraphQL"),(0,i.kt)("p",null,"Nous recommandons d'utiliser le playground GraphQL pour une premi\xe8re prise en main de l'API Voir ",(0,i.kt)("a",{parentName:"p",href:"/guides/playground"},"Guide d'utilisation du playground"),". Vous pouvez \xe9galement utiliser cURL ou n'importe quelle librairie HTTP dans le langage de votre choix."),(0,i.kt)("p",null,"Dans le standard REST, la m\xe9thode de requ\xeate HTTP (",(0,i.kt)("inlineCode",{parentName:"p"},"GET"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"POST"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"PUT"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"DELETE"),") d\xe9termine le type d'op\xe9ration. Dans le standard GraphQL, un contenu de requ\xeate JSON est pass\xe9 que ce soit pour une ",(0,i.kt)("inlineCode",{parentName:"p"},"query")," ou une ",(0,i.kt)("inlineCode",{parentName:"p"},"mutation"),", la m\xe9thode de requ\xeate est donc toujours ",(0,i.kt)("inlineCode",{parentName:"p"},"POST"),". La seule exception est la requ\xeate d'introspection qui est un simple ",(0,i.kt)("inlineCode",{parentName:"p"},"GET")," sur le point de terminaison GraphQL."),(0,i.kt)("p",null,"Pour faire une requ\xeate GraphQL en utilisant cURL, vous devez faire un ",(0,i.kt)("inlineCode",{parentName:"p"},"POST")," avec un corps JSON. Le corps de la requ\xeate doit contenir une chaine de caract\xe8res appel\xe9e ",(0,i.kt)("inlineCode",{parentName:"p"},"query"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'curl \\\n  -X POST \\\n  -H "Content-Type: application/json" \\\n  -H "Authorization: Bearer <ACCESS_TOKEN>" \\\n  --data " \\\n { \\\n   \\"query\\": \\" \\\n    query { \\\n      me { name } \\\n      }\\" \\\n } \\\n" https://api.trackdechets.beta.gouv.fr/\n')),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"La cha\xeene de caract\xe8res de ",(0,i.kt)("inlineCode",{parentName:"p"},'"query"')," doit \xe9chapper les sauts de lignes pour \xeatre correctement lue par le serveur. Pour le corps du message ",(0,i.kt)("inlineCode",{parentName:"p"},"POST"),", il faut utiliser des guillemets doubles \xe0 l'ext\xe9rieur et \xe9chapper tous les guillements doubles \xe0 l'int\xe9rieur du message."))),(0,i.kt)("h2",{id:"\xe0-propos-des-op\xe9rations-de-type-query-et-mutation"},"\xc0 propos des op\xe9rations de type ",(0,i.kt)("inlineCode",{parentName:"h2"},"query")," et ",(0,i.kt)("inlineCode",{parentName:"h2"},"mutation")),(0,i.kt)("p",null,"Les deux types d'op\xe9ration autoris\xe9es sur l'API GraphQL Trackd\xe9chets sont les ",(0,i.kt)("inlineCode",{parentName:"p"},"queries")," et les ",(0,i.kt)("inlineCode",{parentName:"p"},"mutations"),". Pour faire un parall\xe8le avec le standard REST, les ",(0,i.kt)("inlineCode",{parentName:"p"},"queries")," se comportent comme des requ\xeates ",(0,i.kt)("inlineCode",{parentName:"p"},"GET")," et les mutations se comportent comme des requ\xeates ",(0,i.kt)("inlineCode",{parentName:"p"},"POST"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"PATCH"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"DELETE"),". Le nom de la mutation d\xe9termine l'op\xe9ration qui sera execut\xe9e. Les requ\xeates et mutations ont une forme similaire avec quelques diff\xe9rences."),(0,i.kt)("h3",{id:"queries"},"Queries"),(0,i.kt)("p",null,"Les ",(0,i.kt)("inlineCode",{parentName:"p"},"queries")," GraphQL retournent uniquement les donn\xe9es sp\xe9cifi\xe9es. Pour construire une ",(0,i.kt)("inlineCode",{parentName:"p"},"query")," il faut sp\xe9cifier les champs imbriqu\xe9s jusqu'\xe0 un champs de type scalaire (string, int, etc)."),(0,i.kt)("p",null,"Exemple avec une requ\xeate de profil utilisateur"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"query {\n  me {\n    name\n    email\n    companies {\n      name\n      siret\n    }\n  }\n}\n")),(0,i.kt)("p",null,"Des variables peuvent \xe9galement \xeatre ajout\xe9es sur certaines ",(0,i.kt)("inlineCode",{parentName:"p"},"queries"),"."),(0,i.kt)("p",null,"Exemple avec une requ\xeate d'information entreprise en passant un num\xe9ro siret en variable"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},'query {\n  companyInfos(siret: "13001045700013") {\n    name,\n    address\n  }\n}\n')),(0,i.kt)("h3",{id:"mutations"},"Mutations"),(0,i.kt)("p",null,"Pour construire une mutation, il faut sp\xe9cifier trois choses:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Le nom de la mutation qui correspond \xe0 l'op\xe9ration \xe0 ex\xe9cuter"),(0,i.kt)("li",{parentName:"ol"},"Les donn\xe9es d'input pass\xe9es en argument"),(0,i.kt)("li",{parentName:"ol"},"Les donn\xe9es retourn\xe9es")),(0,i.kt)("p",null,"Exemple avec une requ\xeate permettant d'\xe9diter son profil utilisateur Trackd\xe9chets en ajoutant un num\xe9ro de t\xe9l\xe9phone"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},'mutation {\n  editProfile(phone: "06xxxxxxxx"){\n    id\n    phone\n  }\n}\n')))}d.isMDXComponent=!0}}]);