schema {
  query: Query
  mutation: Mutation
}

type Query {
  """EXPERIMENTAL - Ne pas utiliser dans un contexte de production"""
  bsda(id: ID!): Bsda!
  """EXPERIMENTAL - Ne pas utiliser dans un contexte de production"""
  bsdas(
    """
    (Optionnel) PAGINATION
    Permet en conjonction avec `first` de paginer "en avant"
    (des bordereaux les plus récents aux bordereaux les plus anciens)
    Curseur après lequel les bordereaux doivent être retournés
    Attend un identifiant (propriété `id`) de BSD
    Défaut à vide, pour retourner les bordereaux les plus récents
    Le BSD précisé dans le curseur ne fait pas partie du résultat
    """
    after: ID
    """
    (Optionnel) PAGINATION
    Permet en conjonction avec `last` de paginer "en arrière"
    (des bordereaux les plus anciens aux bordereaux les plus récents)
    Curseur avant lequel les bordereaux doivent être retournés
    Attend un identifiant (propriété `id`) de BSD
    Défaut à vide, pour retourner les bordereaux les plus anciens
    Le BSD précisé dans le curseur ne fait pas partie du résultat
    """
    before: ID
    """
    (Optionnel) PAGINATION
    Permet en conjonction avec `cursorAfter` de paginer "en avant"
    (des bordereaux les plus récents aux bordereaux les plus anciens)
    Nombre de bordereaux retournés après le `cursorAfter`
    Défaut à 50, maximum à 500
    """
    first: Int
    """
    (Optionnel) PAGINATION
    Nombre de bordereaux retournés avant le `cursorBefore`
    Défaut à 50, maximum à 500
    """
    last: Int
    where: BsdaWhere
  ): BsdaConnection!
}

type Bsda {
  """Précedents BSDA associés, constituant l'historique de traçabilité"""
  associations: [BsdaAssociation]
  """Date de création"""
  createdAt: DateTime!
  """Installation de destination"""
  destination: BsdaDestination
  """Maitre d'ouvrage ou détenteur du déchet"""
  emitter: BsdaEmitter
  """Bordereau n°"""
  id: String!
  """Indique si le bordereau est à l'état de brouillon"""
  isDraft: Boolean!
  """Conditionnement"""
  packagings: [BsdaPackaging!]
  """Quantité"""
  quantity: BsdaQuantity
  """Statur du bordereau"""
  status: BsdaStatus!
  """Entreprise de transport"""
  transporter: BsdaTransporter
  """
  Type de bordereau
  Le type de bordereau impacte le workflow et les champs obligatoires
  """
  type: BsdaType
  """Date de dernière modification"""
  updatedAt: DateTime!
  """Dénomination du déchet"""
  waste: BsdaWaste
  """Entreprise de travaux"""
  worker: BsdaWorker
}

type BsdaAssociation {
  id: ID!
  status: BsdaStatus!
}

enum BsdaStatus {
  AWAITING_CHILD
  INITIAL
  PROCESSED
  REFUSED
  SENT
  SIGNED_BY_PRODUCER
  SIGNED_BY_WORKER
}

"""
Le scalaire `DateTime` accepte des chaines de caractères
formattées selon le standard ISO 8601. Exemples:
- "yyyy-MM-dd" (eg. 2020-11-23)
- "yyyy-MM-ddTHH:mm:ss" (eg. 2020-11-23T13:34:55)
- "yyyy-MM-ddTHH:mm:ssX" (eg. 2020-11-23T13:34:55Z)
- "yyyy-MM-dd'T'HH:mm:ss.SSS" (eg. 2020-11-23T13:34:55.987)
- "yyyy-MM-dd'T'HH:mm:ss.SSSX" (eg. 2020-11-23T13:34:55.987Z)
"""
scalar DateTime

type BsdaDestination {
  """N° de CAP (le cas échéant)"""
  cap: String
  """Établissement de destination"""
  company: FormCompany
  """Réalisation de l'opération (case 11)"""
  operation: BsdaOperation
  """Opération d'élimination / valorisation prévue (code D/R)"""
  plannedOperationCode: String
  """Expédition reçue à l'installation de destination"""
  reception: BsdaReception
}

"""Information sur un établissement dans un BSD"""
type FormCompany {
  """Adresse de l'établissement"""
  address: String
  """Nom du contact dans l'établissement"""
  contact: String
  """
  Code ISO 3166-1 alpha-2 du pays d'origine de l'entreprise :
  https://fr.wikipedia.org/wiki/ISO_3166-1_alpha-2
  
  Seul la destination ultérieure case 12 (`form.nextDestination.company`) peut être à l'étranger.
  """
  country: String
  """Email du contact dans l'établissement"""
  mail: String
  """Nom de l'établissement"""
  name: String
  """Numéro de téléphone de contact dans l'établissement"""
  phone: String
  """SIRET de l'établissement"""
  siret: String
  """Numéro de TVA intracommunautaire"""
  vatNumber: String
}

type BsdaOperation {
  """Code D/R"""
  code: String
  """Date de réalisation de l'opération"""
  date: DateTime
  signature: Signature
}

type Signature {
  author: String
  date: DateTime
}

type BsdaReception {
  """Lot accepté, accepté partiellement ou refusé"""
  acceptationStatus: BsdaAcceptationStatus
  """Date de présentation sur site"""
  date: DateTime
  """Quantité présentée"""
  quantity: BsdaQuantity
  """Motif de refus"""
  refusalReason: String
  """Signature case 10"""
  signature: Signature
}

enum BsdaAcceptationStatus {
  ACCEPTED
  PARTIALLY_REFUSED
  REFUSED
}

type BsdaQuantity {
  """Type de quantité (réelle ou estimé)"""
  type: BsdaQuantityType
  """Quantité en tonne"""
  value: Float
}

enum BsdaQuantityType {
  ESTIMATED
  REAL
}

type BsdaEmitter {
  """Établissement MOA/détenteur. Partiellement rempli si l'émetteur est en fait un particulier"""
  company: FormCompany
  """Déclaration générale"""
  emission: BsdaEmission
  """Indique si le détenteur est un particulier ou une entreprise"""
  isPrivateIndividual: Boolean
  """Informations chantier (si différente de l'adresse de l'entreprise)"""
  worksite: BsdaWorksite
}

type BsdaEmission {
  signature: Signature
}

type BsdaWorksite {
  address: String
  city: String
  """Autres informations, notamment le code chantier"""
  infos: String
  name: String
  postalCode: String
}

type BsdaPackaging {
  """Description du conditionnement dans le cas où le type de conditionnement est `AUTRE`"""
  other: String
  """Nombre de colis associés à ce conditionnement"""
  quantity: Int!
  """Type de conditionnement"""
  type: BsdaPackagingType!
}

enum BsdaPackagingType {
  BIG_BAG
  BODY_BENNE
  DEPOT_BAG
  OTHER
  PALETTE_FILME
  SAC_RENFORCE
}

type BsdaTransporter {
  """Coordonnées de l'entreprise de transport"""
  company: FormCompany
  """Récépissé transporteur"""
  recepisse: BsdaRecepisse
  """Déclaration générale"""
  transport: BsdaTransport
}

type BsdaRecepisse {
  department: String
  number: String
  validityLimit: DateTime
}

type BsdaTransport {
  signature: Signature
}

"""
4 types de bordereaux possibles:
  - Collecte dans un établissement 2710-1 (déchetterie)
  - Autres collectes
  - Regroupement
  - Ré-expédition
"""
enum BsdaType {
  COLLECTION_2710
  GATHERING
  OTHER_COLLECTIONS
  RESHIPMENT
}

type BsdaWaste {
  """Mention ADR"""
  adr: String
  """Rubrique Déchet"""
  code: String
  """Consistence"""
  consistence: BsdaConsistence
  """Code famille"""
  familyCode: String
  """Nom du matériau"""
  materialName: String
  """Dénomination usuelle"""
  name: String
  """Numéros de scellés"""
  sealNumbers: [String!]
}

enum BsdaConsistence {
  OTHER
  PULVERULENT
  SOLIDE
}

type BsdaWorker {
  """Entreprise de travaux"""
  company: FormCompany
  """Déclaration générale"""
  work: BsdaWork
}

type BsdaWork {
  """
  Indique si l'entreprise de travaux a une signature papier du MOA/détenteur du déchet
  Remettre une signature papier permet au détenteur de ne pas à avoir à signer sur la plateforme
  """
  hasEmitterPaperSignature: Boolean
  signature: Signature
}

input BsdaWhere {
  _and: [BsdaWhere!]
  _not: [BsdaWhere!]
  _or: [BsdaWhere!]
  createdAt: DateFilter
  destination: BsdaDestinationWhere
  emitter: BsdaEmitterWhere
  isDraft: Boolean
  status: BsdaStatus
  transporter: BsdaTransporterWhere
  updatedAt: DateFilter
  worker: BsdaWorkerWhere
}

input DateFilter {
  _eq: DateTime
  _gt: DateTime
  _gte: DateTime
  _lt: DateTime
  _lte: DateTime
}

input BsdaDestinationWhere {
  company: BsdaCompanyWhere
  operation: BsdaOperationWhere
}

input BsdaCompanyWhere {
  siret: String!
}

input BsdaOperationWhere {
  signature: BsdaSignatureWhere
}

input BsdaSignatureWhere {
  date: DateFilter!
}

input BsdaEmitterWhere {
  company: BsdaCompanyWhere
  emission: BsdaEmissionWhere
}

input BsdaEmissionWhere {
  signature: BsdaSignatureWhere
}

input BsdaTransporterWhere {
  company: BsdaCompanyWhere
  transport: BsdaTransportWhere
}

input BsdaTransportWhere {
  signature: BsdaSignatureWhere
}

input BsdaWorkerWhere {
  company: BsdaCompanyWhere
  work: BsdaWorkWhere
}

input BsdaWorkWhere {
  signature: BsdaSignatureWhere
}

type BsdaConnection {
  edges: [BsdaEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type BsdaEdge {
  cursor: String!
  node: Bsda!
}

type PageInfo {
  endCursor: String
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  startCursor: String
}

type Mutation {
  """
  EXPERIMENTAL - Ne pas utiliser dans un contexte de production
  Crée un Bsda
  """
  createBsda(input: BsdaInput!): Bsda
  """
  EXPERIMENTAL - Ne pas utiliser dans un contexte de production
  Crée un Bsda en brouillon
  """
  createDraftBsda(input: BsdaInput!): Bsda
  """
  EXPERIMENTAL - Ne pas utiliser dans un contexte de production
  Duplique un Bsda
  """
  duplicateBsda(
    """ID d'un BSD"""
    id: ID!
  ): Bsda
  """
  EXPERIMENTAL - Ne pas utiliser dans un contexte de production
  Permet de publier un brouillon pour le marquer comme prêt à être envoyé
  """
  publishBsda(id: ID!): Bsda
  """
  EXPERIMENTAL - Ne pas utiliser dans un contexte de production
  Signe un Bsda
  """
  signBsda(id: ID!, input: BsdaSignatureInput!): Bsda
  """
  EXPERIMENTAL - Ne pas utiliser dans un contexte de production
  Met à jour un Bsda
  """
  updateBsda(id: ID!, input: BsdaInput!): Bsda
}

input BsdaInput {
  """Installation de destination"""
  destination: BsdaDestinationInput
  """Maitre d'ouvrage ou détenteur du déchet"""
  emitter: BsdaEmitterInput
  """Conditionnement"""
  packagings: [BsdaPackagingInput!]
  """Quantité"""
  quantity: BsdaQuantityInput
  """ Entreprise de transport"""
  transporter: BsdaTransporterInput
  """
  Type de bordereau
  Le type de bordereau impacte le workflow et les champs obligatoires
  """
  type: BsdaType
  """Dénomination du déchet"""
  waste: BsdaWasteInput
  """Entreprise de travaux"""
  worker: BsdaWorkerInput
}

input BsdaDestinationInput {
  """N° de CAP (le cas échéant)"""
  cap: String
  """Établissement de destination"""
  company: CompanyInput
  """Réalisation de l'opération (case 11)"""
  operation: BsdaOperationInput
  """Opération d'élimination / valorisation prévue (code D/R)"""
  plannedOperationCode: String
  """Expédition reçue à l'installation de destination"""
  reception: BsdaReceptionInput
}

"""Payload d'un établissement"""
input CompanyInput {
  """Adresse de l'établissement"""
  address: String
  """Nom du contact dans l'établissement"""
  contact: String
  """Email du contact dans l'établissement"""
  mail: String
  """Nom de l'établissement"""
  name: String
  """Numéro de téléphone de contact dans l'établissement"""
  phone: String
  """SIRET de l'établissement"""
  siret: String
  """Numéro de TVA intracommunautaire"""
  vatNumber: String
}

input BsdaOperationInput {
  """Code D/R"""
  code: String
  """Date de réalisation de l'opération"""
  date: DateTime
}

input BsdaReceptionInput {
  """Lot accepté, accepté partiellement ou refusé"""
  acceptationStatus: BsdaAcceptationStatus
  """Date de présentation sur site"""
  date: DateTime
  """Quantité présentée"""
  quantity: BsdaQuantityInput
  """Motif de refus"""
  refusalReason: String
}

input BsdaQuantityInput {
  """Type de quantité (réelle ou estimé)"""
  type: BsdaQuantityType
  """Quantité en tonne"""
  value: Float
}

input BsdaEmitterInput {
  """Établissement MOA/détenteur. Partiellement rempli si l'émetteur est en fait un particulier"""
  company: CompanyInput
  """Indique si le détenteur est un particulier ou une entreprise"""
  isPrivateIndividual: Boolean
  """Informations chantier (si différente de l'adresse de l'entreprise)"""
  worksite: BsdaWorksiteInput
}

input BsdaWorksiteInput {
  address: String
  city: String
  """Autres informations, notamment le code chantier"""
  infos: String
  name: String
  postalCode: String
}

input BsdaPackagingInput {
  """Description du conditionnement dans le cas où le type de conditionnement est `AUTRE`"""
  other: String
  """Nombre de colis associés à ce conditionnement"""
  quantity: Int!
  """Type de conditionnement"""
  type: BsdaPackagingType
}

input BsdaTransporterInput {
  """Entreprise de transport"""
  company: CompanyInput
  recepisse: BsdaRecepisseInput
}

input BsdaRecepisseInput {
  department: String
  number: String
  validityLimit: DateTime
}

input BsdaWasteInput {
  """Mention ADR"""
  adr: String
  """Rubrique Déchet"""
  code: String
  """Consistence"""
  consistence: BsdaConsistence
  """Code famille"""
  familyCode: String
  """Nom du matériau"""
  materialName: String
  """Dénomination usuelle"""
  name: String
  """Numéros de scellés"""
  sealNumbers: [String!]
}

input BsdaWorkerInput {
  """Entreprise de travaux"""
  company: CompanyInput
  """Déclaration générale"""
  work: BsdaWorkInput
}

input BsdaWorkInput {
  """
  Indique si l'entreprise de travaux a une signature papier du MOA/détenteur du déchet
  Remettre une signature papier permet au détenteur de ne pas à avoir à signer sur la plateforme
  """
  hasEmitterPaperSignature: Boolean
}

input BsdaSignatureInput {
  """Nom et prénom du signataire"""
  author: String!
  """Date de la signature"""
  date: DateTime
  """Code de sécurité de l'entreprise pour laquelle on signe. Permet de signer en tant que. Optionnel"""
  securityCode: Int
  """Type de signature apposé"""
  type: BsdaSignatureType!
}

enum BsdaSignatureType {
  EMISSION
  OPERATION
  TRANSPORT
  WORK
}

"""
URL de téléchargement accompagné d'un token
permettant de valider le téléchargement.
"""
type FileDownload {
  """Lien de téléchargement"""
  downloadLink: String
  """Token ayant une durée de validité de 10s"""
  token: String
}

scalar JSON

"""Type de quantité lors de l'émission"""
enum QuantityType {
  """Quantité estimée"""
  ESTIMATED
  """Quntité réelle"""
  REAL
}

enum TransportMode {
  AIR
  RAIL
  RIVER
  ROAD
  SEA
}

"""Statut d'acceptation d'un déchet"""
enum WasteAcceptationStatusInput {
  """Accepté en totalité"""
  ACCEPTED
  """Refus partiel"""
  PARTIALLY_REFUSED
  """Refusé"""
  REFUSED
}

"""Informations sur une adresse chantier"""
type WorkSite {
  address: String
  city: String
  infos: String
  name: String
  postalCode: String
}
