version: 2.1

executors:
  node:
    docker:
      - image: circleci/node:10.13.0-browsers
    working_directory: ~/project/trackdechets

jobs:
  build-and-push:
    description: "Build all images, pushes them to the Docker repository if branch is master or dev"
    executor: node
    parameters:
      extra-cfg:
        type: string
        default: ""
    steps:
      - checkout
      - setup_remote_docker
      - run: |
          touch .env
      - run:
          name: Run tests
          command: |
            for container in $(docker-compose -f docker-compose.test.yml ps --services | tr '\r\n' '\n');
            do
              docker-compose -f docker-compose.test.yml run --rm $container
              code=$?
              if [[ $code != "0" ]]; then
                echo "Tests failed for ${container}, exit code ${code}"
                exit 1
              fi
            done
      - run:
          name: "Build and push images"
          command: |
            docker-compose -f docker-compose.yml -f docker-compose.build.yml << parameters.extra-cfg >> build
            if [ "${CIRCLE_BRANCH}" == "master" ] || [ "${CIRCLE_BRANCH}" == "dev" ]; then
              docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASSWORD
              docker-compose -f docker-compose.yml -f docker-compose.build.yml << parameters.extra-cfg >> push --ignore-push-failures
            fi

  deploy:
    machine:
      enabled: true
    working_directory: ~/project/trackdechets
    parameters:
      user:
        type: env_var_name
        default: SSH_USER
      host:
        type: env_var_name
        default: SSH_HOST
      isValidation:
        type: boolean
        default: false
    steps:
      - checkout
      - run:
          name: Deploy Over SSH
          command: |
            scp docker-compose.yml ${<< parameters.user >>}@${<< parameters.host >>}:/srv/trackdechets/
            <<# parameters.isValidation >>
            scp docker-compose.val.yml ${<< parameters.user >>}@${<< parameters.host >>}:/srv/trackdechets/docker-compose.override.yml
            <</ parameters.isValidation >>
            ssh ${<< parameters.user >>}@${<< parameters.host >>} "cd /srv/trackdechets/
            docker-compose pull
            docker-compose up -d
            docker exec \$(docker ps -qf 'name=td-api') npx prisma deploy"

  integration-tests:
    machine:
      enabled: true
    working_directory: ~/project/trackdechets
    steps:
      - checkout
      - run:
          name: Install Node Version Manager
          command: |
            curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
            export NVM_DIR="/opt/circleci/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm install v8.12.0
            nvm alias default v8.12.0
            echo 'export NVM_DIR="/opt/circleci/.nvm"' >> $BASH_ENV
            echo "[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"" >> $BASH_ENV
      - run:
          name: Run integration tests
          command: |
            cd integration-tests
            sudo chmod +x ./run.sh
            ./run.sh

workflows:
  build-and-deploy:
    jobs:
      - build-and-push:
          name: build-and-push-prod
          filters:
            branches:
              only: master
      - build-and-push:
          name: build-and-push-staging
          extra-cfg: "-f docker-compose.val.yml"
          filters:
            branches:
              only: dev
      - deploy:
          name: deploy-prod
          requires:
            - build-and-push-prod
          filters:
            branches:
              only: master
      - deploy:
          name: deploy-sandbox
          host: SSH_HOST_ST
          requires:
            - build-and-push-prod
          filters:
            branches:
              only: master
      - deploy:
          name: deploy-staging
          host: SSH_HOST_BU
          isValidation: true
          requires:
            - build-and-push-staging
          filters:
            branches:
              only: dev
